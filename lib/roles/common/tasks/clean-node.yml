- name: Stop kubelet service
  systemd:
    name: kubelet.service
    state: stopped
    enabled: no
    daemon_reload: yes
  ignore_errors: yes

- name: Clean Kubernetes systemd unit
  file:
    path: /etc/systemd/system/kubelet.service
    state: absent

- name: Clean Kubernetes systemd unit
  file:
    path: /lib/systemd/system/kubelet.service
    state: absent

- name: Clean Kubernetes systemd unit generated by kubeadm
  file:
    path: /etc/systemd/system/kubelet.service.d
    state: absent

- name: Clear containers
  shell: |
    if [[ "$(command -v docker)" != "" ]]; then
      docker rm -f `docker ps -a --format "{{ '{{' }}.Names{{ '}}' }}"  | grep -v simple-kube | awk '{ print $1 }'`
    fi

    if [[ "$(command -v crictl)" != "" ]]; then
      crictl -r unix:///var/run/containerd/containerd.sock rm -f `crictl -r unix:///var/run/containerd/containerd.sock ps -qa`
    fi
  args:
    executable: /bin/bash
  ignore_errors: yes

- name: Clean Kubernetes configuraion
  file:
    path: /etc/kubernetes
    state: absent

- name: Clean Kubernetes release
  file:
    path: /root/kubernetes-release
    state: absent
